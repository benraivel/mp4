---
title: "mp4"
author: "Ben Raivel"
date: "4/29/2019"
output:
  html_document:
    code_folding: hide
---

```{r, message = FALSE, warning = FALSE}
library(tidyverse)
library(RMySQL)
library(sf)
library(leaflet)


db <- dbConnect(MySQL(), 
                host = "scidb.smith.edu", 
                user = "mth292", 
                password = "RememberPi", 
                dbname = "citibike")
knitr::opts_chunk$set(connection = db, max.print = 20)

queried_data <- dbGetQuery(db, "SELECT t1.station_id, t1.end_station_id, s1.avg_lat as start_lat, 
s1.avg_lon as start_lon, s2.avg_lat as end_lat, s2.avg_lon as end_lon, travelcount as travels
FROM (select start_station_id as station_id, end_station_id, 2018 - avg(birth_year) as age, count(*) as travelcount
from citibike.trips
group by start_station_id, end_station_id
order by travelcount desc
limit 100) as t1
JOIN citibike.station_months s1 ON t1.station_id = s1.station_id
JOIN citibike.station_months s2 ON t1.end_station_id = s2.station_id
group by t1.station_id, t1.end_station_id
order by travels desc
limit 100;")
```

```{r}

point1df <- select(queried_data, travels, start_lon, start_lat)
point2df <- select(queried_data, travels, end_lon, end_lat)

point1_sf <- st_as_sf(point1df, coords = c("start_lon","start_lat"))
point2_sf <- st_as_sf(point2df, coords = c("end_lon","end_lat"))

point_bind <- rbind(point1_sf, point2_sf)

point_sf <- point_bind %>%
  group_by(travels) %>%
  summarize(do_union = FALSE) %>%
  st_cast("LINESTRING")

pal <- colorNumeric(palette = "viridis", domain = point_sf$travels)

leaflet() %>%
  addTiles() %>%
  addPolylines(data = point_sf, color = ~pal(travels), opacity = 1)
```

<iframe width="560" height="315" src="https://www.youtube.com/embed/iWwr13pY76E" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

[Github Repository](https://github.com/benraivel/mp4)